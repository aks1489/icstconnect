-- REPAIR SCRIPT: Run this to fix "column does not exist" errors
-- WARNING: This will reset the course structure data (Modules/Topics) to ensure a clean state.

-- 1. Drop existing tables to clear bad schema caching or malformed tables
DROP TABLE IF EXISTS public.student_topic_progress CASCADE;
DROP TABLE IF EXISTS public.course_topics CASCADE;
DROP TABLE IF EXISTS public.course_modules CASCADE;

-- 2. Re-create Course Modules
CREATE TABLE public.course_modules (
    id bigint generated by default as identity primary key,
    course_id bigint references public.courses(id) on delete cascade not null,
    title text not null,
    description text,
    sort_order integer default 0,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Re-create Course Topics
CREATE TABLE public.course_topics (
    id bigint generated by default as identity primary key,
    module_id bigint references public.course_modules(id) on delete cascade not null,
    title text not null,
    description text,
    sort_order integer default 0,
    created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. Re-create Student Topic Progress
CREATE TABLE public.student_topic_progress (
    id bigint generated by default as identity primary key,
    student_id uuid references public.profiles(id) on delete cascade not null,
    topic_id bigint references public.course_topics(id) on delete cascade not null,
    status text default 'completed' check (status in ('completed', 'pending')),
    completed_at timestamp with time zone default timezone('utc'::text, now()) not null,
    completed_by uuid references public.profiles(id),
    unique(student_id, topic_id)
);

-- 5. Re-enable RLS Policies
ALTER TABLE public.course_modules ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.course_topics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.student_topic_progress ENABLE ROW LEVEL SECURITY;

-- 6. Create permissive policies for development (Admin/Teacher/Student)
CREATE POLICY "Public read modules" ON public.course_modules FOR SELECT USING (true);
CREATE POLICY "Public write modules" ON public.course_modules FOR ALL USING (auth.role() = 'authenticated');

CREATE POLICY "Public read topics" ON public.course_topics FOR SELECT USING (true);
CREATE POLICY "Public write topics" ON public.course_topics FOR ALL USING (auth.role() = 'authenticated');

CREATE POLICY "Public read progress" ON public.student_topic_progress FOR SELECT USING (true);
CREATE POLICY "Public write progress" ON public.student_topic_progress FOR ALL USING (auth.role() = 'authenticated');

-- 7. Verification Output
SELECT 'Schema Repair Completed Successfully' as status;
